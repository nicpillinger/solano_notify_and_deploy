namespace :solano do

  namespace :notify do

    desc 'build start - notify hipchat'
    task :build_start do
      notify 'CI starting', 'green'
    end

    desc 'build complete - notify hipchat'
    task :build_complete do
      notify_build_status
    end

  end

  desc 'build complete - notify hipchat and deploy on successful build'
  task :notify_and_deploy do
    notify_build_status "- will not deploy, to deploy manually try rake solano:deploy"
    next unless build_passed?
    deploy
  end

  desc 'run the deploy (notify hipchat on failure)'
  task :deploy do
    deploy
  end

  private

    def tddium?
      ENV['TDDIUM'].present?
    end

    def passed?
      ENV['TDDIUM_BUILD_STATUS'] == 'passed'
    end

    def build_passed?
      tddium? && passed?
    end

    def deploy
      succeeded = false
      message = ""

      begin
        succeeded = system('curl -X POST -d "" <%= deploy_hook_url %>')
      rescue Exception => e
        succeeded = false
        message = e.message
      end

      unless succeeded
        notify "Deploy failed: #{message}", 'red'
        raise "deployment failed"
      end
    end

    def notify_build_status(failed_message = '')
      notify "CI succeeded", "green" and return if build_passed?
      notify "CI failed #{failed_message}", "yellow"
    end

    def notify(message, colour)
      client = HipChat::Client.new('<%= hipchat_api_key %>')
      client['<%= hipchat_room_id %>'].send('Solano CI', message, :color => colour)
    end

end
